---
title: "Proyecto Ciencia de Datos II"
author: "Maxi Urso"
date: "2023-07-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Importo librerías

```{r message=FALSE}
library(tidyverse)
library(sf)
library(ggplot2)
library(scales)
library(ggmap)
```

# Levanto base escuelas

```{r message=FALSE}
escuelas <- read_csv('data/establecimientos_educativos_WGS84.csv')
summary(escuelas)
```

# Veo dimensión de la base

```{r}
dim(escuelas)
```

**2973 registros, 27 columnas.**

# Veo columnas de la base escuelas

```{r}
colnames(escuelas)
```

# Selecciono columnas

Dejo las columnas con las que me voy a quedar

```{r}
escuelas <- escuelas %>% 
  select(cue,nombre_abr,depfun,de,comuna,barrio)

```

# Inspecciono campos

```{r}
summary(escuelas)
```

## Cantidad de escuelas por dependencia funcional

```{r}
table(escuelas$depfun)
```

# Filtrando elementos

Voy a quitar las dependencias funcionales con menos de 10 establecimientos

Para ello tengo que agrupar y contar.

Luego ordeno por dependencia funcional en orden descendente.

```{r}
escuelas_agrup_depfun <- escuelas %>% 
  group_by(depfun) %>% 
  summarise(cantidad = n()) %>% 
  arrange(-cantidad)

print(escuelas_agrup_depfun)

```

## Me quedo con las dependencias funcionales con menos de 10 establecimientos

```{r}

dep_funcs_chicas <- escuelas_agrup_depfun %>% 
  filter(cantidad < 10)

print(dep_funcs_chicas)

```

Quiero eliminar de la base escuelas las que corresponden a estas dependencias funcionales.

Para ello construyo una lista de las dependencias funcionales chicas

```{r}
lista_dep_funcs_chicas <- dep_funcs_chicas$depfun

lista_dep_funcs_chicas
```

Ahora quito de la base esas escuelas

```{r}

escuelas <- escuelas %>% 
  filter(!(depfun %in% lista_dep_funcs_chicas))

```

Chequeo que ya no estén.

```{r}
table(escuelas$depfun)
```

Veo que todas son mayores a 10.

# Chequeo si hay y elimino valores nulos

```{r}
any(is.na(escuelas$depfun))

escuelas <- drop_na(escuelas)

```

# Grafico cantidad de escuelas por dependencia funcional

```{r}

ggplot(escuelas, aes(y = factor(depfun)))+
  geom_bar(fill = "steelblue", color = "black", stat = "count") +
  labs(title = "Establecimientos por Dependencia Funcional", y = "Dependencia funcional", x = "Cantidad")

```

# Quito todo lo que sea gerencias

Y me quedo solo con las que contienen la palabra "Dirección"

```{r}
escuelas_direcciones <- escuelas %>% 
  filter(grepl("Dirección",depfun))

table(escuelas_direcciones$depfun)
```

# Gráficos de tortas

Para conocer las proporciones de escuelas por Dirección.

## Separo las de gestión privada y las de gestión estatal

```{r}
escuelas_estatales_privadas <- escuelas_direcciones %>% 
  mutate(est_priv = case_when(depfun == "Dirección General de Educación de Gestión Privada" ~ 'Privadas',
                              .default = 'Estatales')) %>%
  group_by(est_priv) %>%
  summarise(cantidad = n()) %>%
  arrange(cantidad) %>% 
  mutate (pct = round((cantidad / sum(cantidad))*100,digits=2),
          lab.ypos = cumsum(pct) - 0.5*pct) #Esto es para acomodar etiquetas de pct

escuelas_estatales_privadas
```

```{r}
ggplot(escuelas_estatales_privadas, aes(x = "", y=pct, fill = est_priv))+
  geom_bar(width=1, stat = 'identity', color = 'white')+
  coord_polar('y',start=0)+
  geom_text(aes(y=lab.ypos, label = percent(pct, scale = 1, accuracy = 0.01)), color='white')+
  theme_void()+
  labs(title = "Porcentaje de establecimientos de gestión Estatal/Privada", fill = "Estatales/Privados")
  
```

## Eliminando las de gestion privada

Me quedo sólo con las de gestión estatal para calcular porcentajes entre primarias, iniciales, medias, etc.

```{r}

escuelas_estatales <- escuelas_direcciones %>% 
  filter(depfun != "Dirección General de Educación de Gestión Privada") %>% 
  group_by(depfun) %>% 
  summarise(cantidad = n()) %>% 
  arrange(cantidad) %>% 
  mutate (pct = round((cantidad / sum(cantidad))*100,digits=2),
          lab.ypos = cumsum(pct) - 0.5*pct) #Esto es para acomodar etiquetas de pct

escuelas_estatales

```

Voy a dejar en la categoría "Otra" a las dependencias funcionales con menos de 100 escuelas.

```{r}
escuelas_estatales <- escuelas_direcciones %>% 
  filter(depfun != "Dirección General de Educación de Gestión Privada") %>% 
  mutate(depfun = case_when(depfun == 'Dirección de Escuelas Normales Superiores' ~ 'Otra DF',
                            depfun == 'Dirección de EducaciónTécnica Superior' ~ 'Otra DF',
                            depfun == 'Dirección de Educación Técnica' ~ 'Otra DF',
                            depfun == 'Dirección de Educación Especial' ~ 'Otra DF',
                            depfun == 'Dirección de Educación Artística' ~ 'Otra DF',
                            .default = depfun)) %>% 
  group_by(depfun) %>% 
  summarise(cantidad = n()) %>% 
  arrange(cantidad) %>% 
  mutate (pct = round((cantidad / sum(cantidad))*100,digits=2)) %>% 
  mutate (lab.ypos = cumsum(pct) - 0.5*pct)  %>%  #Esto es para acomodar etiquetas de pct+
  mutate(legend_labs = paste0(depfun, " (",pct, "%)"))


escuelas_estatales
```

```{r}

ggplot(escuelas_estatales, aes(x = 2, y = pct, fill = legend_labs)) +
  geom_bar(stat = "identity", color = "white") +
  coord_polar(theta = "y", start = 0, direction = -1)+
  geom_text(aes(label = percent(pct, scale = 1, accuracy = 0.01) ), size=3, position=position_stack(vjust=0.5))+
  theme_void()+
  xlim(0.5, 2.5)+
  labs(title = "Porcentaje de establecimientos de gestión Estatal por Dependencia Funcional", fill = "Dependencia Funcional")

```

# Mapa de escuelas en CABA

Voy a graficar con puntos la distribución de las escuelas en CABA.

Levanto el dataset de establecimientos educativos (ahora desde el geojson) para tener las coordenadas.

Además, levanto el geojson de las comunas de CABA.

```{r message=FALSE, warning=FALSE}

escuelas_caba <- st_read("data/establecimientos_educativos_WGS84.geojson",
                        stringsAsFactors = TRUE, #Carga strings como categorías
                        options = "ENCODING=latin1")

comunas_caba <- st_read("data/comunas_caba.geojson",
                        stringsAsFactors = TRUE, #Carga strings como categorías
                        options = "ENCODING=latin1")

comunas_caba <- comunas_caba %>% 
  mutate(comuna = COMUNAS)

dim(comunas_caba)

```

Me quedo sólo con las correspondientes a alguna Dirección (quito gerencias)

```{r}
escuelas_caba <- escuelas_caba %>% 
  filter(grepl("Dirección",depfun))

```

```{r}
ggplot()+
  geom_sf(data=comunas_caba)+
  geom_sf(data=escuelas_caba, aes(color=depfun), alpha=0.3)+
  labs(color="Dependencia Funcional")+
  theme_minimal()+
  labs(title="Escuelas en CABA por Dependencia Funcional")
```

# Cantidad de escuelas por Comuna

```{r}
cant_escuelas_comunas <- escuelas_direcciones %>% 
  group_by(comuna) %>% 
  summarise(cantidad = n()) %>% 
  select(comuna,cantidad)
```

**Al dataset de comunas le uno el de cantidad de escuelas**

```{r}
comunas_caba <- left_join(comunas_caba,cant_escuelas_comunas, by="comuna")
```

## Gráfico de barras de escuelas por comunas

```{r}
ggplot(data = comunas_caba,
       aes(x = factor(comuna), y = cantidad, fill=cantidad))+ 
  geom_col(colour = 'black',
           alpha = 0.7)+
  scale_fill_gradient(low = "#e5f5e0", high = "#31a354")+
  labs (title = "Cantidad de escuelas por Comuna",
        x = "Comunas",
        y = "Cantidad de escuelas")+
  geom_text(aes(label = cantidad), hjust = -0.1)+ # Muestra los números sobre las barras
  theme_minimal()+
  coord_flip() #Roto el gráfico para que quede horizontal
```

## Mapa coroplético con la cantidad de escuelas por comuna

```{r}
ggplot()+
  geom_sf(data=comunas_caba, aes(fill=cantidad))+
    scale_fill_distiller(palette = "RdYlGn", direction = 1)+ #El direction 1 da vuelta la paleta de colores
      labs(title="Cantidad de escuelas por Comuna",
       fill="")
```

# Ubicación de las escuelas de gestión Privada/Estatal

```{r}

escuelas_estatales_privadas <- escuelas_caba %>% 
  mutate(est_priv = case_when(depfun == "Dirección General de Educación de Gestión Privada" ~ 'Privada',
                              .default = 'Estatal'))
```

## Agregando un mapa de contexto

```{r message=FALSE, warning=FALSE}
bbox_caba <- st_bbox(comunas_caba)
print(bbox_caba)

#Paso a numéricos el bbox
bbox_caba <- as.numeric(bbox_caba)
mapa_caba <- get_stamenmap(bbox = as.numeric(bbox_caba), #Repito pero no hace falta
                           maptype = "terrain", #Estilo de mapa
                           zoom=13)
```

```{r message=FALSE, warning=FALSE}

ggmap(mapa_caba)+
  geom_sf(data=comunas_caba, inherit.aes=FALSE)+
  geom_sf(data=escuelas_estatales_privadas, aes(color=est_priv),inherit.aes=FALSE, alpha=0.3)+
  labs(color="Gestión")+
  theme_minimal()+
  labs(title="Escuelas en CABA según gestión Estatal/Privada")
```

Voy a facetar el mapa según escuelas de gestión Estatal o Privada para verlo con más claridad

```{r message=FALSE, warning=FALSE}
ggmap(mapa_caba)+
  geom_sf(data=comunas_caba, inherit.aes=FALSE)+
  geom_sf(data=escuelas_estatales_privadas, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2]), inherit.aes=FALSE)+
  facet_wrap(~est_priv)


```

# Escuelas privadas por comuna

Filtro para quedarme con sólo las escuelas con dependencia funcional "Dirección General de Educación de Gestión Privada"

```{r}

escuelas_privadas_por_comuna <- escuelas %>% 
  filter(depfun == "Dirección General de Educación de Gestión Privada") %>% 
  group_by(comuna) %>%
  summarise(cantidad = n()) %>% 
  arrange(-cantidad)

escuelas_privadas_por_comuna

```

```{r}
ggplot(data = escuelas_privadas_por_comuna,
       aes(x = factor(comuna), y = cantidad, fill=cantidad))+ 
  geom_col(colour = 'black',
           alpha = 0.7)+
  scale_fill_gradient(low = "#e5f5e0", high = "#31a354")+
  labs (title = "Cantidad de escuelas privadas por Comuna",
        x = "Comunas",
        y = "Cantidad de escuelas")+
  geom_text(aes(label = cantidad), hjust = -0.1)+ # Muestra los números sobre las barras
  theme_minimal()+
  coord_flip() #Roto el gráfico para que quede horizontal
```

## Mapa coroplético de escuelas privadas por comuna

A comunas_caba le tengo que joinear el escuelas_privadas_por_comuna

```{r}
comunas_caba <- st_read("data/comunas_caba.geojson",
                        stringsAsFactors = TRUE, #Carga strings como categorías
                        options = "ENCODING=latin1")

comunas_caba <- comunas_caba %>% 
  mutate(comuna = COMUNAS)

escuelas_privadas_por_comuna <- left_join(comunas_caba,escuelas_privadas_por_comuna, by="comuna")
```

```{r}
ggplot()+
  geom_sf(data=escuelas_privadas_por_comuna, aes(fill=cantidad))+
    scale_fill_distiller(palette = "RdYlGn", direction = 1)+ 
      labs(title="Cantidad de escuelas privadas por Comuna",
       fill="")
```

# Escuelas según cantidad de población

## Levanto base censo 2010

```{r}
censo_2010 <- read.csv('data/partidos_censo2010.csv')

summary(censo_2010)
```

**Chequeo nombres de columnas**

```{r}
colnames(censo_2010)
```

**Veo qué valores tiene la columna nombre**

```{r}
table(censo_2010$nombre)
```

**Filtro solo los datos de CABA**

Para ello voy a seleccionar sólo las que contienen la palabra "Comuna"

```{r message=FALSE, warning=FALSE}

censo_2010_CABA <- censo_2010 %>% 
  filter(str_detect(nombre, "Comuna"))

```

**Genero una columna Comuna** 

En la misma sólo voy a poner el número de la comuna para poder joinear

Tengo que castear a double porque sino queda como character

```{r message=FALSE, warning=FALSE}
censo_2010_CABA_comunas <- censo_2010_CABA %>% 
  mutate(comuna = as.double(str_remove(nombre, "Comuna ")))

```

**Joineo censo con base de escuelas**

```{r message=FALSE, warning=FALSE}
comunas_caba <- left_join(comunas_caba, censo_2010_CABA_comunas, by="comuna")
comunas_caba <- left_join(comunas_caba, cant_escuelas_comunas, by="comuna")

```

**Calculo escuelas por cantidad de poblacion**

En base a los datos del censo de 2010, por cada 1000 habitantes y cada 1000 viviendas.

```{r message=FALSE, warning=FALSE}

escuelas_poblacion <- comunas_caba %>% 
  mutate(escuelas_por_1000_hab = cantidad/(pob_2010/1000),
         escuelas_por_1000_viv = cantidad/(viv_2010/1000)) %>% 
  arrange(-escuelas_por_1000_hab)

```

# Gráfico de escuelas por cada 1000 habitantes por Comuna

```{r message=FALSE, warning=FALSE}

escuelas_poblacion <- escuelas_poblacion %>% 
  arrange(comuna)

ggplot(escuelas_poblacion, aes(x = escuelas_por_1000_hab, y = reorder(nombre,comuna))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(x = "Escuelas por cada 1000 habitantes", y = "Comuna") +
  ggtitle("Escuelas por cada 1000 habitantes por Comuna")
```

## Cantidad de escuelas privadas por cada 1000 habitantes por Comuna

```{r message=FALSE, warning=FALSE}

escuelas_priv_agrup_comuna_censo <-
  left_join(escuelas_privadas_por_comuna,censo_2010_CABA_comunas,by="comuna") %>%
  mutate(escuelas_por_1000_hab = cantidad/(pob_2010/1000)) %>% 
  arrange(-escuelas_por_1000_hab)

```

```{r}
ggplot(escuelas_priv_agrup_comuna_censo, aes(y = reorder(nombre,comuna))) +
  geom_bar(aes(x = escuelas_por_1000_hab), stat = "identity", position = "dodge") +
  labs(x = "Cantidad de escuelas privadas por cada 1000 habitantes", y = "Comunas") +
  ggtitle("Cantidad de escuelas privadas por habitantes por Comuna")
```

# Comparación de cantidad de escuelas por cada 1000 habitantes

Voy a generar un facetado para ver en dos mapas coropléticos la relación entre cantidad de escuelas de gestión estatal y de gestión privada por comuna.

Para ello tengo que generar un dataset que contenga, por cada comuna, la cantidad de escuelas privadas y la cantidad de escuelas estatales por cada 1000 habitantes.

Tengo los datos:

-   censo_2010_CABA_comunas

-   escuelas_estatales_privadas

```{r message=FALSE, warning=FALSE}

cant_escuelas_est_priv_comunas <- escuelas_estatales_privadas %>% 
  group_by(comuna,est_priv) %>% 
  summarise(cantidad = n())

```

A esto le tengo que joinear la base de censo_2010 para luego calcular la relación

```{r warning=FALSE}
cant_escuelas_est_priv_comunas <- left_join(cant_escuelas_est_priv_comunas,
                                            censo_2010_CABA_comunas,
                                            by="comuna")
```

Ahora le agrego una columna para calcular la relación entre cantidad de escuelas y cantidad de habitantes

```{r message=FALSE, warning=FALSE}
cant_escuelas_est_priv_comunas <- cant_escuelas_est_priv_comunas %>% 
  mutate(escuelas_por_1000_hab = cantidad/(pob_2010/1000))
```

Levanto y joineo el mapa de comunas_caba para poder graficar el coroplético

```{r message=FALSE, warning=FALSE}

comunas_caba <- st_read("data/comunas_caba.geojson",
                        stringsAsFactors = TRUE, #Carga strings como categorías
                        options = "ENCODING=latin1") %>% 
  mutate(comuna = COMUNAS)

cant_escuelas_est_priv_comunas <- st_join(comunas_caba, cant_escuelas_est_priv_comunas)

```

Grafico mapa coroplético facetado por estatales y privadas

```{r}
ggplot()+
   geom_sf(data=cant_escuelas_est_priv_comunas, aes(fill=escuelas_por_1000_hab))+
   scale_fill_distiller(palette = "RdYlGn", direction = 1)+
  facet_wrap(~est_priv)+
  labs(title= "Cantidad de escuelas de gestión Estatal/Privada",
       subtitle = "Por cada 1000 habitantes por Comuna",
       fill="")

```
